/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    /*
     * Apply the Java Gradle plugin development plugin to add support for
     * developing Gradle plugins.
     */
    id 'java-gradle-plugin'

    //---* Apply the Groovy plugin to add support for Groovy *-----------------
    id 'groovy'
}   //  plugins

project.version = "0.1.0"

repositories {
    //---* Use Maven Central for resolving dependencies *----------------------
    mavenCentral()

    /*
     * Use the plugin portal to apply community plugins in convention
     * plugins.
     */
    gradlePluginPortal()

}   //  repositories

publishing {
    publications {
        foundationGitpublisherPublication( MavenPublication ) {
            from components.java
            pom {
                name = "org.tquadrat.gradle.gitpublisher"
                group = "org.tquadrat.tool"
                description = "The GIT Publisher Gradle Plugin"
                version = project.version
            }
        }
    }
}   //  publishing

dependencies {
    //---* The Gradle API *----------------------------------------------------
    implementation gradleApi()

    //---* JGit *--------------------------------------------------------------
    implementation 'org.eclipse.jgit:org.eclipse.jgit:6.0.0.202111291000-r'
}   //  dependencies

java {
    //---* Switch on Java module support *-------------------------------------
    modularity.inferModulePath = true

    //---* Create the Jar with the sources *-----------------------------------
    withSourcesJar()

    //---* Create the Jar with the JavaDoc *-----------------------------------
    withJavadocJar()
}   //  java

testing {
    suites {
        //---* Configure the built-in test suite *-----------------------------
        test {
            //---* Use Spock test framework *----------------------------------
            useSpock( '2.0-groovy-3.0' )
        }

        //---* Create a new test suite *---------------------------------------
        functionalTest( JvmTestSuite ) {
            //---* Use Spock test framework *----------------------------------
            useSpock( '2.0-groovy-3.0' )

            dependencies {
                /*
                 * functionalTest test suite depends on the production code in
                 * tests.
                 */
                implementation project
            }

            targets {
                all {
                    /*
                     * This test suite should run after the built-in test suite
                     * has run its tests.
                     */
                    testTask.configure { shouldRunAfter( test ) }
                }
            }
        }
    }
}   //  testing

gradlePlugin {
    //---* Define the plugin *-------------------------------------------------
    plugins {
        publishToGIT {
            id = 'org.tquadrat.foundation.gradle.gitpublisher'
            implementationClass = 'org.tquadrat.foundation.gradle.gitpublisher.GITPublisherPlugin'
        }
    }
}   //  gradlePlugin

task sourceJar( type: Jar ) {
    archiveClassifier.set( "sources" )
}   //  task sourceJar

gradlePlugin.testSourceSets( sourceSets.functionalTest )

tasks.named( 'check' ) {
    //---* Include functionalTest as part of the check lifecycle *-------------
    dependsOn(testing.suites.functionalTest)
}

tasks.withType( JavaCompile ) {
    //---* Enable the preview features *---------------------------------------
    options.compilerArgs += "--enable-preview"
}

tasks.withType( Test ) {
    //---* Enable the preview features *---------------------------------------
    jvmArgs += "--enable-preview"
}

tasks.withType( JavaExec ) {
    //---* Enable the preview features *---------------------------------------
    jvmArgs += '--enable-preview'
}